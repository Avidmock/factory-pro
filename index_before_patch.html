<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Factory Pro - –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω –ö–æ–Ω—Ç—Ä–æ–ª</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        /* === CSS –ù–ï –ï –ü–ò–ü–ê–ù === */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary:#FF6B35; --primary-dark:#E5552E; --success:#06D6A0;
            --danger:#EF476F; --warning:#FFD166; --dark:#1a1a2e;
            --light:#f8f9fa; --gray:#6c757d;
        }
        body {
            font-family:'Inter',sans-serif;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            min-height:100vh;padding:10px;
        }
        /* ‚Ä¶ (CSS –æ—Å—Ç–∞–≤–∞ 1:1 –∫–∞–∫—Ç–æ –ø—Ä–∏ —Ç–µ–±, –Ω–µ –µ —Å—ä–∫—Ä–∞—â–∞–≤–∞–Ω –ª–æ–≥–∏—á–µ—Å–∫–∏) */
    </style>
</head>

<body>

<!-- ================= NAV ================= -->
<div class="nav-tabs">
    <button class="nav-tab active" onclick="switchTab('production')">üìù<span>–û—Ç—á–∏—Ç–∞–Ω–µ</span></button>
    <button class="nav-tab" onclick="switchTab('dashboard')">üìä<span>–¢–∞–±–ª–æ</span></button>
    <button class="nav-tab" onclick="switchTab('control')">‚ö†Ô∏è<span>–ö–æ–Ω—Ç—Ä–æ–ª</span></button>
    <button class="nav-tab" onclick="switchTab('settings')">‚öôÔ∏è<span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></button>
</div>

<!-- ================= PRODUCTION ================= -->
<div id="production-container" class="container active">
<div class="header">
    <h1>üè≠ –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω –ö–æ–Ω—Ç—Ä–æ–ª</h1>
    <p>–°–∫–∞–Ω–∏—Ä–∞–π –∏ –æ—Ç—á–µ—Ç–∏ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–æ—Ç–æ</p>
</div>
<div class="content">
<form id="productionForm">

<!-- Worker -->
<div class="field">
    <div class="field-label"><span>üë§ –†–∞–±–æ—Ç–Ω–∏–∫</span>
        <button type="button" class="scan-btn" onclick="startScan('worker')">üì∑ –°–∫–∞–Ω–∏—Ä–∞–π</button>
    </div>
    <input id="workerInput" class="field-input" readonly>
    <div id="workerDecoded" class="decoded-info"></div>
</div>

<!-- Order -->
<div class="field">
    <div class="field-label"><span>üßæ –ü–æ—Ä—ä—á–∫–∞</span>
        <button type="button" class="scan-btn" onclick="startScan('order')">üì∑ –°–∫–∞–Ω–∏—Ä–∞–π</button>
    </div>
    <input id="orderInput" class="field-input" readonly>
    <div id="orderDecoded" class="decoded-info"></div>
</div>

<!-- ======= ADD: MODEL ======= -->
<div class="field">
    <div class="field-label"><span>ü™ë –ú–æ–¥–µ–ª</span></div>
    <select id="modelSelect" class="field-input"></select>
</div>

<!-- ======= ADD: PART ======= -->
<div class="field">
    <div class="field-label"><span>üß© –î–µ—Ç–∞–π–ª</span></div>
    <select id="partSelect" class="field-input"></select>
</div>

<!-- Operation -->
<div class="field">
    <div class="field-label"><span>‚öôÔ∏è –û–ø–µ—Ä–∞—Ü–∏—è</span></div>
    <input id="operationInput" class="field-input" readonly>
    <div id="operationDecoded" class="decoded-info"></div>
</div>

<!-- Quantity -->
<div class="field">
    <div class="field-label"><span>üî¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</span></div>
    <input type="number" id="quantityInput" class="field-input" min="1">
</div>

<button type="submit" class="submit-btn" id="submitBtn" disabled>‚úì –ó–ê–ü–ò–®–ò</button>
</form>
</div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
let currentScanField=null;
let html5QrCode=null;

const STORAGE_KEY='factory_pro_logs';
const SETTINGS_KEY='factory_pro_settings';

/* ========= ADD: ROUTING DATA ========= */
const ROUTING_DATA={
models:[{
model_code:"POLUX",
model_name:"–ü–æ–ª—É–∫—Å",
parts:[
{part_code:"BK",part_name:"–ó–∞–¥–µ–Ω –∫—Ä–∞–∫",qty_per_product:2,
operations:[
{step_no:1.1,operation_name:"–†–∞–∑–∫—Ä–æ—è–≤–∞–Ω–µ –ø–æ –¥—ä–ª–∂–∏–Ω–∞",machine:"–ü–µ–Ω–¥—É–ª–∞"},
{step_no:1.2,operation_name:"–†–∞–∑–∫—Ä–æ—è–≤–∞–Ω–µ –ø–æ —à–∏—Ä–∏–Ω–∞",machine:"–ë–∞–Ω—Ü–∏–≥ / –î–∏–Ω"},
{step_no:1.3,operation_name:"4-—Å—Ç—Ä–∞–Ω–Ω–æ —Ä–µ–Ω–¥–æ—Å–≤–∞–Ω–µ",machine:"4-—Å—Ç—Ä–∞–Ω–∫–∞"},
{step_no:1.5,operation_name:"CNC –æ–±—Ä–∞–±–æ—Ç–∫–∞",machine:"CNC TWIN"}
]},
{part_code:"PK",part_name:"–ü—Ä–µ–¥–µ–Ω –∫—Ä–∞–∫",qty_per_product:2,
operations:[
{step_no:2.1,operation_name:"–†–∞–∑–∫—Ä–æ—è–≤–∞–Ω–µ –ø–æ –¥—ä–ª–∂–∏–Ω–∞",machine:"–ü–µ–Ω–¥—É–ª–∞"},
{step_no:2.2,operation_name:"–†–∞–∑–∫—Ä–æ—è–≤–∞–Ω–µ –ø–æ —à–∏—Ä–∏–Ω–∞",machine:"–ë–∞–Ω—Ü–∏–≥ / –î–∏–Ω"},
{step_no:2.3,operation_name:"4-—Å—Ç—Ä–∞–Ω–Ω–æ —Ä–µ–Ω–¥–æ—Å–≤–∞–Ω–µ",machine:"4-—Å—Ç—Ä–∞–Ω–∫–∞"},
{step_no:2.4,operation_name:"–û–∫—Ä–∞–π—á–≤–∞–Ω–µ",machine:"–¶–∏—Ä–∫—É–ª—è—Ä"}
]}
]}]
};

function initRoutingUI(){
const m=document.getElementById("modelSelect");
const p=document.getElementById("partSelect");
m.innerHTML=ROUTING_DATA.models.map(x=>`<option value="${x.model_code}">${x.model_name}</option>`).join("");
m.onchange=populateParts;
p.onchange=setNextOperationForSelection;
populateParts();
}
function getSelectedModel(){
return ROUTING_DATA.models.find(m=>m.model_code===modelSelect.value);
}
function populateParts(){
const m=getSelectedModel();
partSelect.innerHTML=m.parts.map(p=>`<option value="${p.part_code}">${p.part_name}</option>`).join("");
setNextOperationForSelection();
}
function getSelectedPart(m){
return m.parts.find(p=>p.part_code===partSelect.value);
}
function getLogs(){
return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");
}
function setNextOperationForSelection(){
const m=getSelectedModel(); const p=getSelectedPart(m);
const logs=getLogs().filter(l=>l.model_code===m.model_code&&l.part_code===p.part_code);
const last=logs.length?Math.max(...logs.map(l=>l.step_no||0)):0;
const next=p.operations.find(o=>o.step_no>last);
if(!next){
operationInput.value="–ó–∞–≤—ä—Ä—à–µ–Ω –¥–µ—Ç–∞–π–ª";
operationDecoded.textContent="–ù—è–º–∞ —Å–ª–µ–¥–≤–∞—â–∞ –æ–ø–µ—Ä–∞—Ü–∏—è";
}else{
operationInput.value=`STEP|${next.step_no}|${next.operation_name}|${next.machine}`;
operationDecoded.textContent=`–°–ª–µ–¥–≤–∞—â–∞: ${next.step_no} ‚Äì ${next.operation_name}`;
}
operationDecoded.classList.add("show");
validateForm();
}

document.addEventListener('DOMContentLoaded',()=>{
loadSettings();
updateDashboard();
setupFormValidation();
initRoutingUI();
});

/* ===== submit: ADD fields only ===== */
document.getElementById('productionForm').addEventListener('submit',e=>{
e.preventDefault();
const data={
id:Date.now(),
date:new Date().toLocaleDateString('bg-BG'),
time:new Date().toLocaleTimeString('bg-BG'),
worker:workerInput.value,
order:orderInput.value,
operation:operationInput.value,
quantity:+quantityInput.value
};
const m=getSelectedModel(); const p=getSelectedPart(m);
data.model_code=m.model_code;
data.model_name=m.model_name;
data.part_code=p.part_code;
data.part_name=p.part_name;
const op=data.operation.split("|");
if(op[0]==="STEP"){data.step_no=+op[1];data.operation_name=op[2];data.machine2=op[3];}
const logs=getLogs(); logs.push(data);
localStorage.setItem(STORAGE_KEY,JSON.stringify(logs));
successDetails.textContent=`${data.part_name} | ${data.quantity} –±—Ä.`;
successScreen.classList.add("show");
setTimeout(()=>{successScreen.classList.remove("show");resetForm();},1500);
});

</script>
</body>
</html>
